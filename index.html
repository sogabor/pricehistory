<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, maximum-scale=1">
  <title>价格管家</title>

  <link href="css/bootstrap.min.css" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="js/fancybox/jquery.fancybox.css" type="text/css" media="screen" />
  <link href="css/style.css" rel="stylesheet" type="text/css">
  <link href="css/font-awesome.css" rel="stylesheet" type="text/css">
  <link href="css/animate.css" rel="stylesheet" type="text/css">
  <link rel="stylesheet" type="text/css" href="css/normalize.css" />
  <link rel="stylesheet" type="text/css" href="css/default.css">
</head>

<body>

  <!--Header_section-->
  <header id="header_wrapper">
    <div class="container">
      <div class="header_box">

        <nav class="navbar navbar-inverse" role="navigation">
          <div class="navbar-header">
            <a class="navbar-brand"  style="font-size: 30px">价格管家</a>
          </div>
          <div id="main-nav" class="collapse navbar-collapse navStyle">
           <ul class="nav navbar-nav" id="mainNav">
            <!-- <li class="active"><a href="#hero_section" class="scroll-link">Home</a></li>  -->
             <li><a href="#bodydata" class="scroll-link">查看价格</a></li>
             <li><a href="#update" class="scroll-link">关注新商品</a></li>
             <!--<li><a href="#helppage" class="scroll-link">Use Help</a></li>-->
             <li><a href="#contact" class="scroll-link">联系方式</a></li>
           </ul>
         </div>
       </nav>
     </div>
   </div>
  </header>
  <!--Header_section-->

  <!--Hero_Section-->
  <section id="hero_section" class="top_cont_outer">
    <div class="hero_wrapper">
      <div class="container">
        <div class="hero_section">
          <div class="row">
            <div class="col-md-12">

              <div class="top_left_cont zoomIn wow animated">
                <h2>618又到了<br> <strong>查看历史价格，识别假打折</strong></h2>

                <div class="underline"></div>
                <p>基于星云大数据<br/>给消费者还原真相</p>

              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>
  <!--Hero_Section-->


  <!--bodydata-->
  <br>
  <section id="bodydata">
    <div class="inner_wrapper aboutUs-container fadeInLeft animated wow">
      <div class="container">

        <!--init_account-->
        <div class="init_account">
          <hr>
          <h2>价格查询</h2>
          <hr>
          <div class="alert alert-info" role="alert">
            请输入商品url地址查询
          </div>
          <div class="row">
            <div class="col-md-6">
              <input type="text" class="form-control input-text" placeholder="商品url地址" id="checkgoods"/>
            </div>

			 <button type="submit" class="btn btn-primary input-btn pull-right" id="checkgoodsbutton">查询</button>
          </div>


            <p>热门商品:</p>
			<button onClick="check('https://item.jd.com/5224000.html')">Macbook</button>
			<button onClick="check('https://item.jd.com/6748052.html')">iphoneX</button>
			<button onClick="check('https://item.jd.com/6946605.html')">华为P20</button>
			<button onClick="check('https://item.jd.com/7437788.html')">小米8</button>

		  
          <br/>
        </div>


	<br><br>
  <section  id="service">
    <div class="container">
      <h2>历史价格</h2>
      <hr>
      <div class="service_wrapper">
		<div class="loading_div" style="display:none;height: 200px;text-align: center;">
          <img src="./img/loading.gif">
		</div>
		 <h6 id="goodsdetail" style="display:none;white-space:pre;"></h6>
        <div class="row">
          <div class="col-md-12">
            <div class="htmleaf-container">
              <div class="htmleaf-content" id="Div1">
                <canvas id="canvas" height="200" width="600" style="display:none;"></canvas>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

 
  <!--Service-->


	</section>
	
	
	
	
	
	<div class="row">
		 <div class="col-md-4">
		  <input type="text" class="form-control input-text" placeholder="最新价格" id="newprice"/>
		</div>
		<div class="col-md-8">
		  <button type="submit" class="btn btn-primary input-btn pull-right" id="upload_data">更新价格</button>
		</div>
	</div>
	
        <!--upload_data-->
        <br>
		<br><br><br><br><br>
		
	<section  id="update">
		<div class="init_account">
			<br>
          <hr>
          <h2>添加关注商品</h2>
          <hr>
		  <div class="row">
				<div class="col-md-4">
				  <input type="text" class="form-control input-text" placeholder="商品名称" id="goodsname"/>
				</div>
				<div class="col-md-4">
				  <input type="text" class="form-control input-text" placeholder="商品所在平台（淘宝/京东..）" id="platform"/>
				</div>
				<div class="col-md-4">
				  <input type="text" class="form-control input-text" placeholder="目前价格" id="nowprice"/>
				</div>
			</div>
         <div class="row">
            <div class="col-md-6">
              <input type="text" class="form-control input-text" placeholder="商品url地址" id="newgoodsurl"/>
            </div>

			 <button type="submit" class="btn btn-primary input-btn pull-right" id="newgoodssubmit">我发现</button>
          </div>
         
          <br/>
        </div>
		<br>
		<br><br><br><br><br>
		


		

        <!--upload_data-->

      </div>
    </div>
  </section>
  <!--bodydata-->




  <!--联系方式Footer-->
  <footer class="footer_wrapper" id="contact">
    <div class="container">
      <section class="page_section contact" id="contact">
        <div class="contact_section">
          <h6>作者邮箱地址:sgabor@163.com </h6>
		  <h6><a href="https://nebulas.io/" target="_blank">基于星云平台开发</a> &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp <a target="_blank" href="https://github.com/ChengOrangeJu/WebExtensionWallet">下载钱包</a></h6>
        </div>
      </section>
    </div>
  </footer>
  <!--Footer-->

  <script type="text/javascript" src="js/jquery-1.11.0.min.js"></script>
  <script type="text/javascript" src="js/bootstrap.min.js"></script>

  <script type="text/javascript" src="js/jquery-scrolltofixed.js"></script>
  <script type="text/javascript" src="js/jquery.nav.js"></script>
  <script type="text/javascript" src="js/jquery.easing.1.3.js"></script>
  <script type="text/javascript" src="js/jquery.isotope.js"></script>
  <script src="js/fancybox/jquery.fancybox.pack.js" type="text/javascript"></script>
  <script type="text/javascript" src="js/wow.js"></script>

  <script type="text/javascript" src="js/custom.js"></script>
  <script type="text/javascript" src="js/Chart.js"></script>
  <script type="text/javascript" src=js/nebPay.js></script>
  <script type="text/javascript" src=js/nebulas.js></script>
  <script src="js/layer/layer.js" type="text/javascript" charset="utf-8"></script>


  
  
  <script type="text/javascript">

	var nebulas = require("nebulas"),
	Account = nebulas.Account,
	neb = new nebulas.Neb();
	neb.setRequest(new nebulas.HttpRequest("https://mainnet.nebulas.io"));
	var NebPay = require("nebpay");
	var nebPay = new NebPay();
	var serialNumber;
	var intervalQuery;
	var dappAddress = "n1vLMQLfzsbadLmCJXgjYGfTv8x7Qy172Xo";
	

	function gettime() {
		var date = new Date();
		var y = date.getFullYear();
		var m = date.getMonth() + 1;
		m = m < 10 ? ('0' + m) : m;
		var d = date.getDate();
		d = d < 10 ? ('0' + d) : d;
		var h = date.getHours();
		h = h < 10 ? ('0' + h) : h;
		var minute = date.getMinutes();
		var second = date.getSeconds();
		minute = minute < 10 ? ('0' + minute) : minute;
		second = second < 10 ? ('0' + second) : second;
		return y + '/'+ m + '/' + d;
	}; 
	
	
	$("#newgoodssubmit").click(function() {
	  var goodsname = $("#goodsname").val();
	  var platform = $("#platform").val();
	  var nowprice = gettime() + '-' + $("#nowprice").val();
	  var newgoodsurl = $("#newgoodsurl").val();


	  
	  if (newgoodsurl == "" || goodsname== "" || $("#nowprice").val() == "") {
		layer.msg("请输入完整信息！");
		return false;
	  }
	  
		var to = dappAddress;
		var value = "0";
		var callFunction = "newgoods"
		var callArgs = "[\"" + newgoodsurl + "\",\"" + goodsname + "\",\"" + platform + "\",\"" + nowprice  + "\"]";

		serialNumber = nebPay.call(to, value, callFunction, callArgs, {
			listener: cbInfoPush
		});

	})

	function cbInfoPush(resp) {
		console.log("response of push: " + resp)
		if(typeof resp == 'string'){
			layer.msg("取消提交");
	   }else{
			var txhash = resp.txhash;
			console.log("txhash: ", txhash);
			
			intervalQuery = setInterval(function(){
				doIntervalQuery2(txhash);
			},5000);
			
		}
	}
	
	function doIntervalQuery2(txhash) {
		neb.api.getTransactionReceipt(txhash).then(function (resp) {
			if(resp.status == 0) {
				console.log("failed ", resp);
				clearInterval(intervalQuery);
			} else if(resp.status == 1) {
				// success
				console.log("success ", resp);
				clearInterval(intervalQuery);
				layer.msg("提交成功");

			} else {
				// waiting
				console.log("查询中...")
			}
		});
	}
	
	
	


	$("#upload_data").click(function() {
	
		var newgoodsurl = $("#checkgoods").val();
		var price = gettime() + '-' + $("#newprice").val();

		  if (newgoodsurl == "") {
			layer.msg("请输入商品url地址！");
			return false;
		  }
		  if ($("#newprice").val() == "") {
			layer.msg("请输入商品新价格！");
			return false;
		  }
	  
		var to = dappAddress;
		var value = "0";
		var callFunction = "updateprice"
		var callArgs = "[\"" + newgoodsurl + "\",\"" + price +  "\"]";

		serialNumber = nebPay.call(to, value, callFunction, callArgs, {
			listener: updateprice
		});

	})

	function updateprice(resp) {
		console.log("response of push: " + resp)
		if(typeof resp == 'string'){
			layer.msg("取消提交");
	   }else{
			var txhash = resp.txhash;
			console.log("txhash: ", txhash);
			
			intervalQuery = setInterval(function(){
				doIntervalQueryupdateprice(txhash);
			},5000);
			
		}
	}
	
	function doIntervalQueryupdateprice(txhash) {
		neb.api.getTransactionReceipt(txhash).then(function (resp) {
			if(resp.status == 0) {
				console.log("failed ", resp);
				clearInterval(intervalQuery);
			} else if(resp.status == 1) {
				// success
				console.log("success ", resp);
				clearInterval(intervalQuery);
				layer.msg("提交成功");
				loaddata();
			} else {
				// waiting
				console.log("查询中...")
			}
		});
	}

	
	function check(url) {
		document.getElementById("checkgoods").value = url;
		loaddata();
	}
	


	$("#checkgoodsbutton").click(function() {
		loaddata();
	})


	function loaddata() {
		var checkgoods = $("#checkgoods").val();
		
		if (checkgoods == "") {
			layer.msg("请输入商品url地址或选择热门商品进行查询！");
			return false;
		 }
	  
		var to = dappAddress;
		var value = "0";
		var callFunction = "getgood"
		var callArgs = "[\"" + checkgoods  + "\"]";
		
		
		$(".loading_div").show();
		$("#goodsdetail").hide();
		
		var c1=document.getElementById("canvas"); 
		if(c1){
			c1.remove();
			$("#Div1").before("<canvas id=\"canvas\" width=\"600\" height=\"200\" style=\"display:none;\"></canvas>");
		}
		nebPay.simulateCall(to, value, callFunction, callArgs, {
			listener: searchHandle
		});
	}
	var haveprint = 0;
	function searchHandle(resp) {

		var res = JSON.parse(resp.result);

		$(".loading_div").hide();
		$("#goodsdetail").hide();
		$("#goodsdetail").text('');
		if (res === 'null' || res.length < 3){
			layer.msg('没有查到商品信息');
			return;
		}
		$("#goodsdetail").show();
		$("#goodsdetail").text(res.platfrom + '     '+  res.goodsname + '     ' + res.key);
		
		var price = res.price;

		var lineChartData = {

		 labels : [],
		  datasets : [
		  {

			label: "price",
			fillColor : "rgba(255,255,255,0.2)",
			strokeColor : "rgba(255,255,255,1)",
			pointColor : "rgba(255,255,255,1)",
			pointStrokeColor : "#000",
			pointHighlightFill : "#000",
			pointHighlightStroke : "rgba(255,255,255,1)",
			data : []
		  },
		  ]
		}

		var date = price.split("|");
		for(var i=0;i<date.length ;i++ ){
			var dateprice = date[i].split("-");
			lineChartData.labels.push(dateprice[0]);
			lineChartData.datasets[0].data.push(dateprice[1]);
		}


		
		
		
		var c1=document.getElementById("canvas"); 
		
		if(c1){
			c1.remove();
			 $("#Div1").before("<canvas id=\"canvas\" width=\"600\" height=\"200\" style=\"display:none;\"></canvas>");
		}
		$("canvas").show();
		var ctx = document.getElementById("canvas").getContext("2d");

		
		window.myLine = new Chart(ctx).Line(lineChartData, {
			responsive: true
		});
		haveprint = 1;
	}
</script>

  
</body>
</html>